<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>DCC Generierung - My Docs</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">My Docs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Anwendung <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../">Iovis removit sparsa</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">DCC Generator</a>
    <ul class="dropdown-menu">
            
<li class="active">
    <a href="./">DCC Generierung</a>
</li>
            
<li >
    <a href="DCC_Generator_DRV8870/">DCC Generator mit Hilfe einer DRV8870-Platine</a>
</li>
            
<li >
    <a href="DCC_Generator_L298N/">DCC Generator mit Hilfe einer L298N-Platine</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Lokdekoder</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../Lokdekoder/Lokdekoder_BTS7960/">Lokdekoder (BTS7960)</a>
</li>
            
<li >
    <a href="../Lokdekoder/Lokdekoder_DRV8870/">Lokdekoder (DRV8870)</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Weichendekoder</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../Weichendekoder/USECASE_Weichendekoder/">Weichendecoder</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Entwicklung <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../Entwicklung/DebugSerial/">Debug über die serielle Schnittstelle</a>
</li>
                                    
<li >
    <a href="../../Entwicklung/Entwicklungsumgebung/">Entwicklungsumgebung</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Old <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../old/Begriff-H-Bridge/">H-Bridge</a>
</li>
                                    
<li >
    <a href="../../old/Erste-Schritte/">Erste Schritte</a>
</li>
                                    
<li >
    <a href="../../old/FAQ/">Nutzung einer z21/Z21</a>
</li>
                                    
<li >
    <a href="../../old/Firmware-Updates/">Firmware Updates</a>
</li>
                                    
<li >
    <a href="../../old/Framework/">Framework</a>
</li>
                                    
<li >
    <a href="../../old/Funktionsumfang/">Funktionsumfang</a>
</li>
                                    
<li >
    <a href="../../old/Platinen/">Platinen</a>
</li>
                                    
<li >
    <a href="../../old/_Footer/"> Footer</a>
</li>
                                    
<li >
    <a href="../../old/_Sidebar/"> Sidebar</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="DCC_Generator_DRV8870/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#dcc-generierung">DCC Generierung</a></li>
            <li><a href="#warum-dieser-ansatz">Warum dieser Ansatz?</a></li>
            <li><a href="#funktionsumfang">Funktionsumfang</a></li>
            <li><a href="#anwendungsfalle">Anwendungsfälle</a></li>
            <li><a href="#technischer-hintergrund">Technischer Hintergrund</a></li>
            <li><a href="#prototypen">Prototypen</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="dcc-generierung">DCC Generierung</h1>
<p>In diesem Fall erzeugt der ESP8266 mit Hilfe einer <a href="Begriff-H-Bridge">H-Bridge</a> ein DCC-Signal mit welchem ein normaler DCC-Decoder angesteuert werden kann.</p>
<p>Die Befehle können z.B. per WLAN an den ESP8266 verschickt werden und dieser generiert ein DCC-Signal für eine H-Bridge. Mit diesem DCC-Signal wird dann ein klassischer DCC-Decoder angesteuert, der dann den Motor regelt.</p>
<p>Z21 App oder Wlan-Maus =&gt; WLAN =&gt; ESP8266 =&gt; H-Bridge =&gt; DCC-Signal =&gt; DCC-Decoder =&gt; Motor / Sound</p>
<p>Es ist darauf zu achten, dass die H-Bridge ausreichend dimensioniert ist. Im Spassbahn-Forum gab es die Diskussion, ob die H-Bridge überhaupt so stark sein muss oder ob es nicht ausreichen würde, den Decoder über den PowerPack-Eingang zu versorgen und eine "schwache" H-Bridge zu nutzen. (Diesen Test überlasse ich gerne anderen Personen)</p>
<p>Die Lösung kann über 2 Wege gesteuert werden:</p>
<ul>
<li>Der Decoder kann sich über WLAN mit einer Z21 verbinden und von dort die Befehle erhalten.
    Die Lok erhält sich in diesem Fall praktisch wie eine Lok, die ihre Befehle über die Schienen erhält.</li>
<li>Der Decoder kann eine Z21 simulieren und ein WLAN-Netz aufspannen.
   Anschließend kann man den Decoder direkt und ohne die Notwendigkeit einer Z21 ansteuern. Die Z21-App oder die WLAN-Maus kann zur Steuerung genutzt werden.</li>
</ul>
<h2 id="warum-dieser-ansatz">Warum dieser Ansatz?</h2>
<p>Zwei Gründe (wovon ich aber nur den ersten wirklich teile)</p>
<ol>
<li>Nutzung von Sound</li>
</ol>
<p>Obwohl es auch möglich wäre, Sound über den ESP8266 abzuspielen, ist die Nutzung eines klassischen DCC-Sounddecoder doch sehr viel einfacher.</p>
<ol>
<li>bessere Qualität der Motoransteuerung</li>
</ol>
<p>Bei der Nutzung einer einfachen H-Bridge zur Motorsteuerung wird meistens nur ein einfaches lastunabhängiges PWM-Signal generiert. Hier sind die DCC-Decoder deutlich weiter.</p>
<h2 id="funktionsumfang">Funktionsumfang</h2>
<ul>
<li>Generiert ein DCC-Signal mit<ul>
<li>128 Fahrstufen</li>
<li>28 Funktionstasten</li>
</ul>
</li>
</ul>
<h2 id="anwendungsfalle">Anwendungsfälle</h2>
<p><a href="USECASE_DCC_Generator_L298N">L298N</a>
<a href="USECASE_DCC_Generator_DRV8870">DRV8870</a></p>
<h2 id="technischer-hintergrund">Technischer Hintergrund</h2>
<h3 id="spi">SPI</h3>
<p>Das Signal wird im ESP8266 über den SPI-Ausgang erzeugt. Dieser Ausgang hat einen Hardware-Buffer, so dass sichergestellt ist, dass das DCC-Timing eingehalten wird. Es wird also immer ein DCC-Paket erzeugt, in das notwendige SPI-Format gewandelt und anschließend in den Hardware-Buffer geschrieben. Bei den ersten Tests stellt sich heraus, dass die SPI-Library beim Senden so lange blockiert, bis das Paket komplett verschickt wurde. Außerdem belegte die Library direkt drei GPIO für MISO, MOSI, SCK. Aus diesem Grund wurde die SPI-Library an die Bedürfnisse dieses Frameworks angepasst. Jetzt wird im einfachsten Fall nur noch ein Pin (13 bzw. D7) genutzt. Dieser Pin ist fest, da er der einzige nutzbare Pin mit Hardware-mäßiger SPI Unterstützung ist.</p>
<h3 id="halbes-dcc">"Halbes" DCC</h3>
<p>An D7 liegt aber nur eine Art "positive Halbwelle" des DCC-Signales an. 
Da das DCC-Signal aber eine Wechselspannung ist, wird auch noch "negative Halbwelle" benötigt. Diese Halbwelle wird aus dem Signal von D7 durch einen Transistor erzeugt, der das Signal invertiert (siehe zweites Signal).
Es werden DCC-Paketen für die Geschwindigkeit und Richtung erzeugt, sowie Pakete für den Zustand von F0 bis F28.</p>
<h2 id="prototypen">Prototypen</h2>
<p>Da Julian Zimmermann, der diesen Ansatz im Spassbahn-Forum <a href="http://www.spassbahn.de/forum/index.php?thread/11462-spa%C3%9Flan-topfschlagen-im-minenfeld/&amp;postID=117854">vorgestellt</a> hatte, keine Zeit hatte ihn zu verfeinern und mich das Technische interessierte, habe ich ihn um die Sourcen gebeten, damit ich es in mein Framework integrieren kann. Nach einigen frustrierenden Abenden habe ich einen Prototypen zum laufen gebracht: Der Motorblock reagierte endlich auf die generierten DCC-Befehle.</p>
<p><a href="http://gartenbahntechnik.de/viewtopic.php?f=22&amp;t=418">Entwicklungsgeschichte</a></p>
<p>Aus diesem Prototypen haben sie die oben genannten Schaltungen entwickelt.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
